docker_build:
  test:
    - has_file: Dockerfile
  depends_on: build
  goals:
    - containers:
        - args:
            - --context=dir:///atm/home
            - --destination=gcr.io/kubernetes-sdm-demo/${push.repo.name}:${push.after.version}
            - --dockerfile=Dockerfile
            - --cache=true
            - --cache-repo=gcr.io/kubernetes-sdm-demo/layer-cache
            - --force
          image: gcr.io/kaniko-project/executor:latest
          name: kaniko
          resources:
            limits:
              cpu: 1000m
              memory: 2048Mi
            requests:
              cpu: 100m
              memory: 1024Mi
            securityContext:
              runAsGroup: 0
              runAsNonRoot: false
              runAsUser: 0
      input:
        - ${push.repo.owner}/${push.repo.name}/${push.sha}/pom
        - ${push.repo.owner}/${push.repo.name}/${push.sha}/target
---
deploy:
  test:
    - has_file: Dockerfile
    - is_default_branch
  depends_on: docker_build
  goals:
    - stagingDeployment
    - productionDeployment
